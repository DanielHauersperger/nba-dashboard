<!DOCTYPE html>
<html>

<head>
    <title>Project 2 Daniel Hauersperger</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>


<style>
    .axis path,
    .axis line {
        stroke: black;
        stroke-width: 1;
        shape-rendering: crispEdges;
    }
    .bar--negative {
        fill: gray
    }
    .bar--positive {
        fill: blue
    }
</style>

<body>
    <div class="row row-cols-1 row-cols-md-2 g-4">
        <div class="col">
          <div class="card shadow-sm">
            <div class="card-body" id="west-rankings">
              <h5 class="card-title">West Rankings</h5>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card shadow-sm">
            <div class="card-body" id="east-rankings">
              <h5 class="card-title">East Rankings</h5>
            </div>
          </div>
        </div>
    </div>

    <!-- below styling based on https://codepen.io/Temmio/pen/gKGEYV -->
    <div id="games" style="overflow-x: auto;" class="row flex-row flex-nowrap mt-4 pb-4 pt-2">
    </div>

    <script>
         function drawRankings(rankings, games_this_season, teams) {
            // Specify which columns to display
            const keys_to_display = ["TEAM", "W", "L"];;
            const display_names = ["Team", "W", "L"];

            const west = d3.select("#west-rankings");
            const west_rankings = rankings.filter(r => r.CONFERENCE == "West");
            drawTable(west, west_rankings, keys_to_display, display_names, "TEAM_ID");

            const east = d3.select("#east-rankings");
            const east_rankings = rankings.filter(r => r.CONFERENCE == "East");
            drawTable(east, east_rankings, keys_to_display, display_names, "TEAM_ID");
            
            // TODO: Clicking a row filters games shown to that team, e.g. row.onclick=changeGamesFilter(this.team)
            // Alternately, can have sidebar open to team info
            // Or, lazily expand a card with the info

            // Add a bar plot of recent performance for each team
            for(team of rankings){
                const team_id = team.TEAM_ID;
                const city = teams.filter(d => d.TEAM_ID == team_id)[0].CITY;
                const team_games = games_this_season.filter(d => d.HOME_TEAM_ID == team_id || d.AWAY_TEAM_ID == team_id);

                const last_10_games = last_n(team_games, "GAME_DATE_EST");
                const display = last_10_games.map(d => ({"key": d.GAME_DATE_EST, "value":d.PTS_away - d.PTS_home}));
                drawSmallBar(`TEAM-${team_id}`, display);
            }
        }

        function drawTable(selector, data, keys_to_display, display_names, id_key=0) {
            const table = selector.append("table")
                .classed("table", true)
                .classed("table-hove", true);
            // Add column headers
            table.append("thead")
                .classed("table-dark", true)
                .append("tr")
                .selectAll("th")
                .data(display_names)
                .enter().append("th")
                    .attr("scope", "col")
                    .text(d => d);
            // Create every row
            const rows = table.append("tbody")
                // .attr("class", )
                .selectAll("tr")
                    .data(data)
                    .enter().append("tr");
            // Put values in the rows
            for (key of keys_to_display){
                rows.append("td")
                    .attr("id", d => `${key}-${d[id_key]}`)
                    .text(d => d[key]);
            }
            return table;
        }

        function drawGames(games, teams, game_details) {
            const getTeam = (team_id) => {
                return teams.find(d => d.TEAM_ID == team_id).ABBREVIATION
            }

            const cards = d3.select("#games")
                .selectAll(".game_div")
                .data(games)
                .enter().append("div")
                    .attr("class", "game_div col-3")
                    .attr("id", d => `game-${d.GAME_ID}`)
            const blocks = cards.append("div")
                    .attr("class", "card card-block align-items-center shadow-sm");
            blocks.append("h1").text(d => {
                return `${getTeam(d.HOME_TEAM_ID)} vs ${getTeam(d.VISITOR_TEAM_ID)}`;
            });
            blocks.append("h2").text(d => {
                return `${d.PTS_home}-${d.PTS_away}`;
            });
            blocks.append("p").text(d => d.GAME_DATE_EST);

            cards.on("click", function(d) {
                const game_id = d.GAME_ID;
                const block = d3.select(`#game-${game_id}`);
                const isExpanded = block.classed('expanded');
                if(isExpanded) {
                    // un-expand the game (hide the details)
                    block.classed("expanded", false);
                    block.classed("col-6", false);
                    
                    // remove the table of game stats
                    block.select(".card").selectAll(".details").remove();
                } else {
                    // expand the game
                    block.classed("expanded", true);
                    block.classed("col-6", true);

                    const card = block.select(".card");
                    const row = card.append("div").attr("class", "details row row-cols-1 row-cols-lg-2");

                    const single_game_details = game_details.filter(r => r.GAME_ID == d.GAME_ID);
                    // draw a summary table for each team
                    for (let isHome of [true, false]){
                        console.log(isHome);
                        const team = isHome ? d.TEAM_ID_home : d.TEAM_ID_away;
                        const team_details = single_game_details.filter(d => d.TEAM_ID == team);
                        
                        const PTS = isHome ? d.PTS_home : d.PTS_away;
                        const FGA = d3.sum(team_details, d => d.FGA);
                        const FGM = d3.sum(team_details, d => d.FGM);
                        const FG3M = d3.sum(team_details, d => d.FG3M);
                        const FG3A = d3.sum(team_details, d => d.FG3A);
                        const summary_team = [{
                            "Points": PTS,
                            "Field Goals": `${FGM}/${FGA} (${Math.round(FGM/FGA*100)}%)`, // e.g. '33/99 (33%)'
                            "3 Pointers": `${FG3M}/${FG3A} (${Math.round(FG3M/FG3A*100)}%)`, // e.g. '5/15 (33%)'
                        }];
                        const columns = Object.keys(summary_team[0]);

                        const table = row.append("div").attr("class", "col")
                            .append("div").attr("class", "card shadow-sm");
                        table.append("h5").text(team_details[0].TEAM_CITY)
                        drawTable(table, summary_team, columns, columns);
                    }
                }
            });
        }

        function drawSmallBar(svg_id, data) {
            // based on https://bl.ocks.org/mbostock/2368837
            var margin = {top: 0, right: 0, bottom: 0, left: 20},// {top: 20, right: 20, bottom: 20, left: 20},
                width = 150 - margin.left - margin.right,
                height = 20 - margin.top - margin.bottom;

            var y = d3.scale.linear()
                .range([0, height]);

            var x = d3.scale.ordinal()
                .rangeRoundBands([0, width], 0.1);

            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left");

            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom")
                .tickSize(0)
                .tickPadding(6)
                .tickFormat("");

            var svg = d3.select(`#${svg_id}`).append("svg")
                .attr("class", "d-none d-sm-inline") // hide on small screens
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
            .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            y.domain(d3.extent(data, function(d) { return d.value; })).nice();
            x.domain(data.map(function(d) { return d.key; }));

            svg.selectAll(".bar")
                .data(data)
                .enter().append("rect")
                .attr("class", function(d) { return "bar bar--" + (d.value < 0 ? "negative" : "positive"); })
                .attr("y", function(d) { return y(Math.min(0, d.value)); })
                .attr("x", function(d) { return x(d.key); })
                .attr("height", function(d) { return Math.abs(y(d.value) - y(0)); })
                .attr("width", x.rangeBand());
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${y(0)})`)
                .call(xAxis)

            function type(d) {
                d.value = +d.value;
            return d;
            }
        }

        function last_n(data, key) {
            // see https://stackoverflow.com/a/1129270
            return data.sort((a,b) => a[key] - b[key])
                        .slice(0, 10)
                        .reverse();
        }

        d3.csv('data/games.csv', function (games) {
            d3.csv('data/ranking.csv', function(rankings) {
                d3.csv('data/teams.csv', function(teams){
                    d3.csv('data/games_details_2021.csv', function(game_details) {
                    const last_games_date = d3.max(games, r => r.GAME_DATE_EST);
                    recent_games = games.filter(r => r.GAME_DATE_EST == last_games_date);
                    drawGames(recent_games, teams, game_details);

                    // first, drawing from the csv
                    // for recent games, I'll need to create this myself from games.csv or pull the data myself
                    // probably best to calculate this on the fly for load speed
                    const last_rankings_date = d3.max(rankings, r => r.STANDINGSDATE);
                    const games_this_season = games.filter(d => d.SEASON == '2021');
                    recent_rankings = rankings.filter(r => r.STANDINGSDATE == last_rankings_date);
                    drawRankings(recent_rankings, games_this_season, teams);
                    });
                });
            });
        });


    </script>

</body>

</html>
