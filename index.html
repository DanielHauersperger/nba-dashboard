<!DOCTYPE html>
<html>

<head>
    <title>Project 2 Daniel Hauersperger</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>


<style>

</style>

<body>
    <div class="row row-cols-1 row-cols-md-2 g-4">
        <div class="col">
          <div class="card shadow-sm">
            <div class="card-body" id="west-rankings">
              <h5 class="card-title">West Rankings</h5>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card shadow-sm">
            <div class="card-body" id="east-rankings">
              <h5 class="card-title">East Rankings</h5>
            </div>
          </div>
        </div>
    </div>

    <!-- below styling based on https://codepen.io/Temmio/pen/gKGEYV -->
    <div id="games" style="overflow-x: auto;" class="row flex-row flex-nowrap mt-4 pb-4 pt-2">
    </div>

    <script>
         function drawRankings(rankings) {
            // Specify which columns to display
            const keys_to_display = ["TEAM", "W", "L"];;
            const display_names = ["Team", "W", "L"];

            const west = d3.select("#west-rankings");
            const west_rankings = rankings.filter(r => r.CONFERENCE == "West");
            drawTable(west, west_rankings, keys_to_display, display_names);

            const east = d3.select("#east-rankings");
            const east_rankings = rankings.filter(r => r.CONFERENCE == "East");
            drawTable(east, east_rankings, keys_to_display, display_names);
            
            // TODO: Clicking a row filters games shown to that team, e.g. row.onclick=changeGamesFilter(this.team)
            // Alternately, can have sidebar open to team info
            // Or, lazily expand a card with the info
        }

        function drawTable(selector, data, keys_to_display, display_names) {
            const table = selector.append("table")
                .classed("table", true)
            // Add column headers
            table.append("thead")
                .classed("table-dark", true)
                .append("tr")
                .selectAll("th")
                .data(display_names)
                .enter().append("th")
                    .attr("scope", "col")
                    .text(d => d);
            // Create every row
            const rows = table.append("tbody")
                // .attr("class", )
                .selectAll("tr")
                    .data(data)
                    .enter().append("tr");
            // Put values in the rows
            for (key of keys_to_display){
                rows.append("td").text(d => d[key]);
            }
        }

        function drawGames(games, teams) {
            const getTeam = (team_id) => {
                return teams.find(d => d.TEAM_ID == team_id).ABBREVIATION
            }

            const cards = d3.select("#games")
                .selectAll(".game_div")
                .data(games)
                .enter().append("div")
                    .attr("class", "game_div col-3")
                    .attr("id", d => `game-${d.GAME_ID}`)
            const blocks = cards.append("div")
                    .attr("class", "card card-block align-items-center shadow-sm");
            blocks.append("h1").text(d => {
                return `${getTeam(d.HOME_TEAM_ID)} vs ${getTeam(d.VISITOR_TEAM_ID)}`;
            });
            blocks.append("h2").text(d => {
                return `${d.PTS_home}-${d.PTS_away}`;
            });
            blocks.append("p").text(d => d.GAME_DATE_EST);

            cards.on("click", function(d) {
                const block = d3.select(`#game-${d.GAME_ID}`);
                const isExpanded = block.classed('expanded');
                if(isExpanded) {
                    // un-expand the game (hide the details)
                    block.classed('expanded', false);
                    block.classed("col-6", false);
                    
                    // remove the table of game stats
                    block.select(".card").select("table").remove();
                } else {
                    // expand the game
                    block.classed('expanded', true);
                    block.classed("col-6", true);

                    const card = block.select(".card");
                    drawTable(card, [d], ["FG_PCT_home", "FG_PCT_away"], ["FG_PCT_home", "FG_PCT_away"]);
                }
            });
        }

        d3.csv('data/games.csv', function (games) {
            d3.csv('data/ranking.csv', function(rankings) {
                d3.csv('data/teams.csv', function(teams){
                    const last_games_date = d3.max(games, r => r.GAME_DATE_EST);
                    recent_games = games.filter(r => r.GAME_DATE_EST == last_games_date);
                    drawGames(recent_games, teams);

                    // first, drawing from the csv
                    // for recent games, I'll need to create this myself from games.csv or pull the data myself
                    // probably best to calculate this on the fly for load speed
                    const last_rankings_date = d3.max(rankings, r => r.STANDINGSDATE);
                    recent_rankings = rankings.filter(r => r.STANDINGSDATE == last_rankings_date);
                    drawRankings(recent_rankings);
                });
            });
        });


    </script>

</body>

</html>
